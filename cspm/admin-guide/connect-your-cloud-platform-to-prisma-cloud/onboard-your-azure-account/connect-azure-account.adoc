== Connect your Azure Account

Effectively monitor your Azure cloud resources and ensure compliance by onboarding your Azure cloud account on Prisma™ Cloud. 

In this topic you will learn how to add your Azure cloud resources to Prisma™ Cloud for threat detection, monitoring and compliance. Choose from one of the options outlined below, based on where you are in your journey with Prisma Cloud:

[cols="50%a,50%a"]
|===

|*Deployment Stage*
|*Resources*

|First-time onboarding
|Choose an onboarding option

|Onboarding Complete
|* xref:update-azure-application-permissions.adoc#idd4a9fb0b-59df-473b-8547-789be4c18ec5[Update Azure Application Permissions]

* xref:create-custom-role-on-azure.adoc#id3817b85a-fbfc-4d4a-bde4-bdb2012b1e02[Create a Custom Role on Azure]

* xref:troubleshoot-azure-account-onboarding.adoc#id6b7e6e40-9ce7-43d8-b5b5-1dcc607d8e9b[Troubleshoot Azure Account Onboarding]

* xref:microsoft-azure-apis-ingested-by-prisma-cloud.adoc#idc4e0a68d-4486-478b-9a1f-bbf8f6d8f905[Microsoft Azure APIs Ingested by Prisma Cloud] 

|===

=== Overview

Use one of the following three options to onboard your Azure cloud resources on Prisma Cloud:

* Azure Tenant (Accounts with Management Groups, Subscriptions and Active Directory) (connects all your Azure resources to Prisma Cloud) 
** Commercial 
** Government
** China
* Azure Subscription (connects a single subscription)
** Commercial 
** Government 
** China
* Azure Active Directory (connects an Active Directory)
** Commercial 
** Government
** China


Using Azure APIs, Prisma Cloud ingests and processes data from your cloud environment and initiates resource monitoring. During the built-in onboarding process you have the option of using one of the following three methods to create the required Azure resources to authorize Prisma Cloud to access Azure APIs:

. Using Terraform Script (Recommended)
This workflow automates the process of setting up the Prisma Cloud application on Azure Active Directory and enables read-only or read-write access to your Azure subscription.
Note: Azure China workflows do not support the use of Terraform templates.
. Using Custom Role JSON file
Using a manually created Custom Role you also have the option to enforce least access privilege to restrict access. To achieve this you will need to manually set up the Prisma Cloud application on Active Directory and Create a Custom Role to authorize access to Azure APIs. 
. Manual
If your organization restricts the use of Terraform scripts, you can choose to manually create the required Azure resources for Prisma Cloud to call the Azure APIs.


=== Prerequisites

To successfully onboard and monitor the resources within your Azure subscription, ensure that you have completed the following prerequisites:

. Get your Azure Subscription ID from the Azure portal. 

. Elevate access for a Global Administrator using Azure portal to enable Prisma Cloud access to Azure subscriptions or management groups. This is needed for ingesting resources associated with subscriptions and management groups only during the initial onboarding of your Azure accounts. You can disable this option after onboarding is complete.

. Enable Prisma Cloud to ingest Azure Key Vault resources.
+
The following Azure resources need to have the *Get* and *List* permissions enabled in the Key Management Operations on Azure Portal for Prisma Cloud to ingest them:
+
** screen:[azure-key-vault-list]

** screen:[azure-key-vault-certificate]
+
Select menu:All{sp}services[Key vaults > (key vault name) > Access policies > + Add Access Policy]. For *Key permissions*, *Secret permissions*, and *Certificate permissions*, add the *Get* and *List* Key Management Operations.
+
image::add-access-policy-azure.png[scale=10]

. Enable Prisma Cloud to obtain network traffic data from Network Security Group (NSG) https://docs.microsoft.com/en-us/azure/network-watcher/network-watcher-nsg-flow-logging-portal[flow logs]. NSG flow logs are a feature of Network Watcher, that allows you to view information about ingress and egress IP traffic through an NSG.
+
** Create one or more network security groups if you have none.

** Create Azure https://docs.microsoft.com/en-us/azure/network-watcher/network-watcher-create[Network Watcher instances] for the virtual networks in every region where you collect NSG flow logs.
Network Watcher enables you to monitor, diagnose, and view metrics to enable and disable logs for resources in an Azure virtual network.

** Create storage accounts to collect NSG flow logs. If you are storing flow logs in a storage account that belongs to a different subscription than the one that is generating the flow logs and is being onboarded, Prisma Cloud can ingest flow logs only when:
+
*** The subscriptions belong to the same Azure AD or Root Management Group (for example, Azure Org).

*** The Service Principal that you use to onboard the subscription on Prisma Cloud has access to read the contents of the storage account.

** Add only the IP addresses for your Prisma Cloud instance from https://docs.paloaltonetworks.com/prisma/prisma-cloud/prisma-cloud-admin/get-started-with-prisma-cloud/enable-access-prisma-cloud-console.html#id7cb1c15c-a2fa-4072-b074-063158eeec08[NAT Gateway IP Addresses for Prisma Cloud]. For example, if your instance is on userinput:[app.prismacloud.io] use the IP addresses associated with that.
+
On the Azure Portal, include the source and the DR Prisma Cloud IP addresses for your Prisma Cloud instance. Select menu:Azure{sp}services[Storage accounts > (your storage account) > Networking > Selected networks].
+
image::azure-selected-networks.png[scale=0]
+
Replace userinput:[your storage account] with the name of your storage account in Azure portal.

** Enable Network Watcher and register Microsoft.InsightsResource Provider. Microsoft.Insights is the resource provider namespace for Azure Monitor, which provides features such as metrics, diagnostic logs, and activity logs.

** Enable NSG flow logs version 1 or 2, based on the regions where NSG flow logs version 2 is supported on Azure.

** Verify that you can view the flow logs.

=== Required Roles and Permissions
*Bring in roles info from docs. Sumanth to provide Gsheet of required permissions and mapping to roles and deployment types*

=== Next: Onboard your Azure Account 
* Azure Tenant (Accounts with Management Groups, Subscriptions and Active Directory) (connects all your Azure resources to Prisma Cloud) 
** Commercial 
** Government
** China
* Azure Subscription (connects a single subscription)
** Commercial 
** Government 
** China
* Azure Active Directory (connects an Active Directory)
** Commercial 
** Government
** China


